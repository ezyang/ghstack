from ghstack.test_prelude import *

init_test()

# Create a stack with two commits
commit("A")
commit("B")
gh_submit("Initial")

# Verify branches exist before cleaning
upstream_sh = get_upstream_sh()
refs_before = upstream_sh.git("for-each-ref", "refs/heads/gh/", "--format=%(refname)")
assert "gh/ezyang/1/" in refs_before, f"Expected branches for PR 1, got: {refs_before}"
assert "gh/ezyang/2/" in refs_before, f"Expected branches for PR 2, got: {refs_before}"

# Close PR #500 (first PR in the stack)
close_pr(500)

# Run clean in dry-run mode first
with captured_output() as (out, err):
    deleted_dry = gh_clean(dry_run=True)

# Branches should still exist after dry run
refs_after_dry = upstream_sh.git("for-each-ref", "refs/heads/gh/", "--format=%(refname)")
assert "gh/ezyang/1/" in refs_after_dry, "Branches should still exist after dry run"

# Verify dry run found the right branches
if is_direct():
    # Direct mode has head, orig, next
    assert len(deleted_dry) >= 2, f"Expected at least 2 branches, got: {deleted_dry}"
else:
    # Non-direct mode has head, base, orig
    assert len(deleted_dry) >= 2, f"Expected at least 2 branches, got: {deleted_dry}"

# Now actually clean
with captured_output() as (out, err):
    deleted = gh_clean(dry_run=False)

# Verify the closed PR branches were deleted
refs_after = upstream_sh.git("for-each-ref", "refs/heads/gh/", "--format=%(refname)")
assert "gh/ezyang/1/" not in refs_after, f"Expected branches for PR 1 to be deleted, got: {refs_after}"

# Verify the open PR branches still exist
assert "gh/ezyang/2/" in refs_after, f"Expected branches for PR 2 to still exist, got: {refs_after}"

# Clean again - should find nothing to clean
with captured_output() as (out, err):
    deleted_again = gh_clean(dry_run=False)
assert len(deleted_again) == 0, f"Expected no branches to delete, got: {deleted_again}"

ok()
